<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidéothèque - La banane pixélisée</title>
    <link rel="icon" type="image/svg+xml" href="/static/banana.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="d-flex flex-column min-vh-100">
    {% set active_page = 'libraries' %}
    {% include '_navbar.html' %}
    
    <div class="container mt-4 flex-grow-1 mb-5">
        {% if messages %}
            <div class="alert alert-{{ messages[0] }} alert-dismissible fade show" role="alert">
                {{ messages[1] }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endif %}
        
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h4>{{ library_data.name if library_data else '-' }}</h4>
                    <p class="text-muted">{{ library_data.description if library_data else 'Aucune description' }}</p>
                    <p class="text-muted small mb-2">
                        Propriétaire : <a href="{{ url_for('profile.profile', user_id=library_data.owner_id) }}">{{ library_data.owner or '-' }}</a>
                    </p>
                    {% if library_data %}
                    <span class="badge bg-{{ 'success' if library_data.visibility == 'public' else 'secondary' }}">
                        {{ 'Public' if library_data.visibility == 'public' else 'Privé' }}
                    </span>
                    {% endif %}
                </div>
                {% if is_owner %}
                <div>
                    <button class="btn btn-sm btn-outline-primary" id="edit-button" onclick="document.getElementById('edit-form').style.display='block';this.style.display='none'">Modifier</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="if(confirm('Êtes-vous sûr de vouloir supprimer cette bibliothèque ?')) { document.getElementById('delete-form').submit(); }">Supprimer</button>
                </div>
                {% endif %}
            </div>
            
            {% if is_owner %}
            <form method="POST" action="/library/{{ library_data.id if library_data else 0 }}" id="edit-form" style="display:none;" class="mt-3">
                <input type="hidden" name="action" value="update_library">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Modifier la bibliothèque</h6>
                        <div class="mb-3">
                            <label for="name" class="form-label">Nom *</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ library_data.name if library_data else '' }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ library_data.description if library_data else '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="visibility" class="form-label">Visibilité</label>
                            <select class="form-select" id="visibility" name="visibility" required>
                                <option value="public" {% if library_data and library_data.visibility == 'public' %}selected{% endif %}>Public</option>
                                <option value="private" {% if library_data and library_data.visibility == 'private' %}selected{% endif %}>Privé</option>
                            </select>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">Enregistrer</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('edit-form').reset();document.getElementById('edit-form').style.display='none';document.getElementById('edit-button').style.display='inline-block';">Annuler</button>
                        </div>
                    </div>
                </div>
            </form>
            
            <form method="POST" action="/library/{{ library_data.id if library_data else 0 }}" id="delete-form" style="display:none;">
                <input type="hidden" name="action" value="delete_library">
            </form>
            {% endif %}
        </div>
        
        <div class="page-header">
            <h5>Médias</h5>
            {% if is_owner %}
            <a href="/add-media" class="btn btn-sm btn-primary">+ Ajouter</a>
            {% endif %}
        </div>
        
        {% if media_items %}
            <div class="items-grid">
                {% for media_item in media_items %}
                <div class="position-relative" style="display: inline-block;">
                    <a href="/media/{{ media_item.id }}" class="media-card" id="media-{{ media_item.id }}">
                        <img src="{{ media_item.cover_image_url or '/static/no-image.jpg' }}" 
                             alt="{{ media_item.title or 'Média' }}" 
                             class="media-card-image">
                        <div class="media-card-body">
                            <h5 class="media-card-title">{{ media_item.title or '-' }}</h5>
                            <p class="media-card-meta">
                                {{ media_item.type or '-' }}
                                {% if media_item.release_year %}- {{ media_item.release_year }}{% endif %}
                            </p>
                        </div>
                    </a>
                    {% if is_owner %}
                    <form method="POST" action="/library/{{ library_data.id if library_data else 0 }}" style="display:inline;" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce média ?');">
                        <input type="hidden" name="action" value="delete_media">
                        <input type="hidden" name="media_id" value="{{ media_item.id }}">
                        <button type="submit" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" 
                                style="z-index: 10; opacity: 0.9;"
                                title="Supprimer le média">
                            ×
                        </button>
                    </form>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <p>Aucun média dans cette bibliothèque</p>
                {% if is_owner %}
                    <a href="/add-media" class="btn btn-primary btn-sm">Ajouter un média</a>
                {% endif %}
            </div>
        {% endif %}
        
        {% if pagination and pagination.pages > 1 %}
        <div class="pagination-container">
            <nav>
                <ul class="pagination pagination-sm">
                    {% if pagination.page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="/library/{{ library_data.id if library_data else 0 }}?page={{ pagination.page - 1 }}">Précédent</a>
                    </li>
                    {% endif %}
                    {% for page_number in range(1, pagination.pages + 1) %}
                    <li class="page-item {% if page_number == pagination.page %}active{% endif %}">
                        <a class="page-link" href="/library/{{ library_data.id if library_data else 0 }}?page={{ page_number }}">{{ page_number }}</a>
                    </li>
                    {% endfor %}
                    {% if pagination.page < pagination.pages %}
                    <li class="page-item">
                        <a class="page-link" href="/library/{{ library_data.id if library_data else 0 }}?page={{ pagination.page + 1 }}">Suivant</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
    
    {% include '_footer.html' %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
